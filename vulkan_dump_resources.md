# Dumping resources

## Index

1. [Introduction](#introduction)
    1. [General](#general)
    2. [Block index and object ID](#block-index-and-object-id)
    3. [Rules for providing command indices](#rules-for-providing-command-indices)
    4. [A simple example](#a-simple-example)
    5. [Index vector dimensionality](#index-vector-dimensionality)
2. [Command line options and input](#command-line-options-and-input)
    1. [gfxrecon-replay command line params](#gfxrecon-replay-command-line-params)
    2. [Input Json file](#input-json-file)
        1. [Json file example](#json-file-example)
3. [Output](#output)
    1. [Generated files](#generated-files)
    2. [Json file output](#json-file-output)

## Introduction

### General

GFXReconstruct offers the capability to dump resources when replaying a capture file. These resources can be:

1. Render targets

    All images used as render target attachments (both as color and depth attachments) either in render passes or with dynamic rendering.

2. Results of compute (vkCmdDispatch and its variants) and ray tracing (vkCmdTraceRays) shaders.

    All result images and buffers used as descriptor bindings by dispatch and ray tracing shaders.

3. Descriptor bindings used as inputs in all shader stages.

    All images and buffers used as descriptor bindings by draw calls, dispatch and ray tracing shaders.

4. Rendering state data such as vertex and index buffers.

The resources are dumped into files and can either be image files (bmp or png) or binary files.

Dumping can take place only while replaying a capture file either on desktop with the `gfxrecon-replay` tool or when replaying a capture file on Android with the replay application.

In order to enable the dump resources feature the DrawCalls and/or Dispatch, and/or TraceRays for which the related resources is desired to be dumped, need to be specified in some way. This is can be done by using the block index with which these commands are recorded inside the capture file (for more details see [Block index](#block-index-and-object-id).

It is possible to dump resources from multiple draw calls and or Dispatch/TraceRays in a single run by specifying multiple indices.

### Block index and object ID

Each command (either a Vulkan command issued by the application or a meta command generated by GFXReconstruct internally) stored in the capture file can be identified by a unique, monotonically increasing number that each command is assigned. This is called the block index of each command. In order to specify commands for dumping their resources this index needs to be specified for each command.

The simplest way to get access to a command block index is to use the `gfxrecon-convert` tool on a capture file which will convert the capture into a human readable json file. The json file looks something like this:

```Json
{"index":301,"function":{"name":"vkBeginCommandBuffer","thread":2,"return":"VK_SUCCESS","args":{"commandBuffer":80, ... }}},
{"index":302,"function":{"name":"vkCmdBeginRenderPass","thread":2,"cmd_index":1,"args":{"commandBuffer":80, ... }}},
{"index":303,"function":{"name":"vkCmdBindPipeline","thread":2,"cmd_index":2,"args":{"commandBuffer":80, ... }}},
{"index":304,"function":{"name":"vkCmdBindDescriptorSets","thread":2,"cmd_index":3,"args":{"commandBuffer":80, ... }}},
{"index":305,"function":{"name":"vkCmdSetViewport","thread":2,"cmd_index":4,"args":{"commandBuffer":80, ... }}},
{"index":306,"function":{"name":"vkCmdSetScissor","thread":2,"cmd_index":5,"args":{"commandBuffer":80, ... }}},
{"index":307,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":80, ... }}},
```

The block index is the `index` key used in each entry. Object ID is

In a similar manner each vulkan object is assigned an object ID. When an object is referenced by a command in the json output of the convert tool, this object is referenced by it's ID. In the above example the `VkCommandBuffer` with object ID 80 is referenced and is common between all commands.

### Rules for providing command indices

Aprt from the DrawCall/Dispatch/TraceRays indices, indices for a few other certain Vulkan commands need to specified. In summary the commands that can be specified are the following:

1. **DrawCalls**
This includes the indices of `vkCmdDraw` and all supported variants of the draw commands. The supported draw call variants are:
    * vkCmdDraw
    * vkCmdDrawIndexed
    * vkCmdDrawIndirect
    * vkCmdDrawIndexedIndirect
    * vkCmdDrawIndirectCount
    * vkCmdDrawIndexedIndirectCount
    * vkCmdDrawIndirectCountKHR
    * vkCmdDrawIndexedIndirectCountKHR

2. **Dispatch**
This includes the indices of `vkCmdDispatch` and all supported variants of the dispatch commands. The supported dispatch variants are:
    * vkCmdDispatch
    * vkCmdDispatchIndirect

3. **Trace rays**
This includes the indices of `vkCmdTraceRaysKHR` commands

Depending on the type of the commands that dumping is requested additional indices need to specified. These commands are:

1. **BeginCommandBuffer**
This is the index of the `vkBeginCommandBuffer` inside which the indices of the dump-able commands are provided.

2. **Render pass**
This concerns only draw calls and must include all render pass indices which concern the provided draw calls. Indices for `vkCmdBeginRenderPass`, `vkCmdNextSubpass` (if any) and `vkCmdEndRenderPass` must be provided. In case of dynamic rendering the indices of `vkCmdBeginRendering` and `vkCmdEndRendering` must be provided instead.

3. **QueueSubmit**
The index of the `vkQueueSubmit` (or `vkQueueSubmit2`) in which the command buffer that includes the desired commands are submitted needs to be provided.

### A simple example

Assuming the following imaginary excerpt from a capture file that contains the following commands:

```Json
{"index":301,"function":{"name":"vkBeginCommandBuffer", ... } },
{"index":302,"function":{"name":"vkCmdBeginRenderPass", ... } },
{"index":303,"function":{"name":"vkCmdBindPipeline", ... } },
{"index":304,"function":{"name":"vkCmdBindDescriptorSets", ... } },
{"index":305,"function":{"name":"vkCmdSetViewport", ... } },
{"index":306,"function":{"name":"vkCmdSetScissor", ... } },
{"index":307,"function":{"name":"vkCmdDraw", ... } },
{"index":308,"function":{"name":"vkCmdDraw", ... } },
{"index":309,"function":{"name":"vkCmdDraw", ... } },
{"index":310,"function":{"name":"vkCmdDraw", ... } },
{"index":311,"function":{"name":"vkCmdDraw", ... } },
{"index":312,"function":{"name":"vkCmdDraw", ... } },
{"index":313,"function":{"name":"vkCmdEndRenderPass", ... } },
{"index":314,"function":{"name":"vkBeginCommandBuffer", ... } },
{"index":315,"function":{"name":"vkCmdDraw", ... } },
{"index":316,"function":{"name":"vkCmdDraw", ... } },
{"index":317,"function":{"name":"vkCmdDraw", ... } },
{"index":318,"function":{"name":"vkCmdDraw", ... } },
{"index":319,"function":{"name":"vkCmdDraw", ... } },
{"index":320,"function":{"name":"vkCmdDraw", ... } },
{"index":321,"function":{"name":"vkCmdEndRenderPass", ... } },
{"index":322,"function":{"name":"vkEndCommandBuffer", ... } },
...
{"index":374,"function":{"name":"vkQueueSubmit", ... } },
```

It is possible to dump the depth and color attachments of all `vkCmdDraw` commands by providing the following indices:

`"BeginCommandBuffer"`: [ `301` ]

`"Draw"`: [ [ `307, 308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318` ] ]

`"RenderPass"`: [ [ [ `302, 313` ], [ `314`, `319` ] ] ]

`"QueueSubmit"`: [ `374` ]

### Index vector dimensionality

Indices are provided in GFXReconstruct as vectors of indices. Each index vector, depending on the type of the command it describes can vary and is important otherwise errors will be generated while parsing the input or the expected commands will not be dumped. Each vector's dimensionality is the following:

* `"BeginCommandBuffer"` and `"QueueSubmit"`: **1D**

Commands recorded in multiple command buffers can be dumped in a single run. For each command buffer the index of the `vkBeginCommandBuffer` mu be provided. The index of the `vkQueueSubmit` in which the command buffer is submitted must be provided. Both these vectors must have the same number of indices.

* `"Draw"`, `"Dispatch"` and `"TraceRays"`: **2D**

These vectors are two dimensional. The first dimension corresponds to `BeginCommandBuffer` each vector belongs to.
I.e.:

```Json
    "BeginCommandBuffer" :  [ 10, 20 ],
    "TraceRays":            [ [ 220, 230, 240 ], [] ],
    "Dispatch" :            [ [], [ 250, 260, 270 ] ],
    "QueueSubmit" :         [ 350, 360 ]
```

In the example above the `vkCmdTraceRay`s `[ 220, 230, 240 ]` belong to `vkBeginCommandBuffer` with block index `10` and are submitted in `vkQueueSubmit` with block index `350`.

`vkCmdDispatch` with indices `[ 250, 260, 270 ]` belong to command buffer with `vkBeginCommandBuffer` with block index `20` and are submitted in `vkQueueSubmit` with block index `360`.

* `"RenderPass"`: **3D**

Inside a command buffer can be recorded multiple render passes with multiple sub-passes. In order to support that for multiple command buffers a 3D array is required.

An example:

A hypothetical json output of the `gfxrecon-convert` tool could look something like the following:

```Json
{"index":10,"function":{"name":"vkBeginCommandBuffer","thread":2,"return":"VK_SUCCESS","args":{"commandBuffer":59, ... }}},
{"index":11,"function":{"name":"vkBeginCommandBuffer","thread":2,"return":"VK_SUCCESS","args":{"commandBuffer":60, ... }}},
{"index":12,"function":{"name":"vkCmdBeginRenderPass","thread":2,"cmd_index":1,"args":{"commandBuffer":59, ... }}},
{"index":13,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":14,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":15,"function":{"name":"vkCmdNextSubpass","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":16,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":17,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":18,"function":{"name":"vkCmdEndRenderPass","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":19,"function":{"name":"vkCmdBeginRenderPass","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":20,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":21,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":22,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":23,"function":{"name":"vkCmdDraw","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":24,"function":{"name":"vkCmdEndRenderPass","thread":2,"cmd_index":6,"args":{"commandBuffer":59, ... }}}
{"index":25,"function":{"name":"vkEndCommandBuffer","thread":2,"return":"VK_SUCCESS","args":{"commandBuffer":59}}}

{"index":26,"function":{"name":"vkCmdBeginRenderPass","thread":2,"cmd_index":1,"args":{"commandBuffer":60, ... }}},
{"index":27,"function":{"name":"vkCmdDrawIndexed","thread":2,"cmd_index":6,"args":{"commandBuffer":60, ... }}}
{"index":28,"function":{"name":"vkCmdDrawIndexed","thread":2,"cmd_index":6,"args":{"commandBuffer":60, ... }}}
{"index":29,"function":{"name":"vkCmdDrawIndexed","thread":2,"cmd_index":6,"args":{"commandBuffer":60, ... }}}
{"index":30,"function":{"name":"vkCmdEndRenderPass","thread":2,"cmd_index":6,"args":{"commandBuffer":60, ... }}}
{"index":31,"function":{"name":"vkEndCommandBuffer","thread":2,"return":"VK_SUCCESS","args":{"commandBuffer":60}}}
...
{"index":50,"function":{"name":"vkQueueSubmit", ... ,"commandBufferCount":1,"pCommandBuffers":[59], ... }},
{"index":51,"function":{"name":"vkQueueSubmit", ... ,"commandBufferCount":1,"pCommandBuffers":[60], ... }},
```

The indices submitted to `gfxrecon-replay` for dumping are the following:

```Json
{
    "BeginCommandBuffer" : [ 10, 11 ],

    "Draw" :               [ [ 13, 14, 16, 17, 20, 21, 22, 23 ],
                             [ 27, 28, 29 ] ],

    "RenderPass" :         [ [ [ 12, 15, 18 ], [ 19, 24 ] ], [ [ 26, 30 ] ] ],

    "QueueSubmit" :        [ 50, 51 ]
}
```

In the above example 2 command buffer are submitted for dumping, one with object ID `59` and one with object ID `60`.

* The first command buffer with object ID `59` and `vkBeginCommandBuffer` with index `10` contains:
  * The draw calls `[ 13, 14, 16, 17, 20, 21, 22, 23 ]`
  * These draw calls are divided into two render passes:
    * `[ 12, 15, 18 ]`: `vkCmdBeginRenderPass`: `12`, `vkCmdNextSubpass`: `15` and `vkCmdEndRenderPass`: `18`
    * `[ 19, 24 ]`: `vkCmdBeginRenderPass`: `19` and `vkCmdEndRenderPass`: `24`
* The second command buffer with object ID `60` and `vkBeginCommandBuffer` with index `20` contains:
  * The draw calls `[ 27, 28, 29 ]`
  * One render pass with 1 sub pass:
    * `[ 26, 30 ]`: `vkCmdBeginRenderPass`: `26` and `vkCmdEndRenderPass`: `30`
* Command buffer `59` is submitted for execution with `vkQueueSubmit` with index `50` and command buffer `60` is submitted in `vkQueueSubmit` with index `51`

## Command line options and input

### gfxrecon-replay command line params

Dump resources feature can be control in several ways. To do so a number of parameters can be provided to either to the `gfxrecon-replay` tool or to the Android application through the `gfxrecon.py` script. These are the following:

```text
--dump-resources BeginCommandBuffer=<n>,Draw=<n>,BeginRenderPass=<n>,NextSubPass=<n>,EndRenderPass=<n>,Dispatch=<n>,TraceRays=<n>,QueueSubmit=<n>
              Dump gpu resources after the given vmCmdDraw*, vkCmdDispatch, or vkCmdTraceRaysKHR is replayed. The parameter for
              each is a block index from the capture file.  The additional parameters are used to identify during which occurence
              of the vkCmdDraw/VkCmdDispath/VkCmdTrancRaysKHR resources will be dumped.  NextSubPass can be repeated 0 or more times to
              indicate subpasses withing a render pass.  Note that the minimal set of parameters must be one of:
                  BeginCmdBuffer, Draw, BeginRenderPass, EndRenderPass, and QueueSubmit
                  BeginCmdBuffer, Dispatch and QueueSubmit
                  BeginCmdBuffer, TraceRays and QueueSubmit
  --dump-resources <filename>
              Extract --dump-resources args from the specified file, with each line in the file containing a comma or space separated
              list of the parameters to --dump-resources. The file can contain multiple lines specifying multiple dumps.
  --dump-resources <filename>.json
              Extract --dump-resource args from the specified json file. The format for the json file is documented in detail
              in the gfxreconstruct documentation.
  --dump-resources-image-format <format>
                        Image file format to use for image resource dumping.
                        Available formats are:
                            bmp         Bitmap file format.  This is the default format.
                            png         Png file format.
  --dump-resources-before-draw
              In addition to dumping gpu resources after the CmdDraw, CmdDispatch and CmdTraceRays calls specified by the
              --dump-resources argument, also dump resources before those calls.
  --dump-resources-scale <scale>
              Scale images generated by dump resources by the given scale factor. The scale factor must be a floating point number
              greater than 0. Values greater than 10 are capped at 10. Default value is 1.0.

  --dump-resources-dir <dir>
              Directory to write dump resources output files. Default is the current working directory.

  --dump-resources-image-format <format>
              Image file format to use when dumping image resources. Available formats are: bmp, png
```

### Input Json file

There is an option to provide the command indices of which the resources need to be dumped in a json file. This can be more convenient when providing indices for multiple commands. The keys expected to be found in the json file are the following:

1. `BeginCommandBuffer`
2. `QueueSubmit`
3. `Draw`
4. `Dispatch`
5. `TraceRays`
6. `RenderPass`

#### Json file example

```Json
{
    "BeginCommandBuffer" :  [ 10, 20 ],

    "Draw" :                [ [ 30, 40, 50,
                                60, 70, 80 ],
                              [ 90, 100, 110,
                               120, 130, 140 ] ],

    "RenderPass" :          [ [ [ 160, 170, 180 ] ], [ [ 190, 200, 210 ] ] ],

    "TraceRays":            [ [ 220, 230, 240 ], [] ],

    "Dispatch" :            [ [], [ 250, 260, 270 ] ],

    "QueueSubmit" :         [ 350, 360 ]
}
```

## Output

### Generated files

Dump resources feature generates a number of output files. These files are either images (in one of the supported image formats) or raw binary files (`.bin`) when the dumped resources is either a buffer on an image with a format which is not converted into a plain 32bit RGBA layout that can be written in a common image file. Generated file names depending on the command that is being dumped:

1. **Draw calls**

For draw calls dump resources feature should dump all color and depth attachments for each draw call.
Usually dumped files' names will have the following pattern `Draw_{[before|after]}_{draw index}_{attachment}_{aspect}.{file extension}` where:

* `{[before|after]}`: Denotes whether the dumped attachment is before or after the execution of the actual command.
* `{draw index}`: Is the block index of the draw call.
* `{attachment}`: Is the index number of the attachment for color attachments or the string `depth_att` for depth attachments.
* `{aspect}`: Is the aspect of the image the file contains (i.e. `COLOR`, `DEPTH` or `STENCIL`)
* `{file extension}`: Either one of the supported image formats or `bin` if the content is dumped raw.

2. **Compute and ray tracing**

Similar to draw calls, compute and ray tracing use the following naming pattern: `{[Dispatch|TraceRays]}_{[before|after]}_{command index}_{set}_{binding}_{aspect}.{file extension}` where `{[Dispatch|TraceRays]}`: Denotes whether the dumped command is a compute or ray tracing command. The other fields are the same as above.

Buffer outputs use the following naming pattern: `{[Dispatch|TraceRays]}_{[before|after]}_{command index}_{set}_{binding}_buffer.bin`

### Json file output
